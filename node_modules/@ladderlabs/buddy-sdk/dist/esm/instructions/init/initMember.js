import { __assign, __awaiter, __generator, __spreadArray } from "tslib";
import { PublicKey } from "@solana/web3.js";
import * as anchor from "@project-serum/anchor";
import { getMemberNamePDA, getMemberPDA, getTokenAccount, getTreasuryPDA, } from "../../utils/pda";
import { parsePublicKey } from "../../utils/parse";
import { ASSOCIATED_TOKEN_PROGRAM_ID, TOKEN_PROGRAM_ID, } from "@solana/spl-token";
import { ORGANIZATION_PDA_NOT_EXIST } from "../../utils/type";
export function initMember(program, authority, memberName, organization, buddy, buddyProfile, 
//@ts-ignore
referrers, referrerTreasuryPDA, payer) {
    if (payer === void 0) { payer = null; }
    return __awaiter(this, void 0, void 0, function () {
        var memberPDA, memberNamePDA, buddyTreasuryPDA, buddyTreasuryATA, referrerTreasuryATA, _a, method;
        return __generator(this, function (_b) {
            switch (_b.label) {
                case 0:
                    if (!organization)
                        throw ORGANIZATION_PDA_NOT_EXIST;
                    memberPDA = getMemberPDA(program, organization.name, memberName);
                    memberNamePDA = getMemberNamePDA(program, organization.name, (buddyProfile === null || buddyProfile === void 0 ? void 0 : buddyProfile.authority) || authority // In case authority of referrer is not the wallet authority
                    );
                    buddyTreasuryPDA = getTreasuryPDA(program, [buddy.pda], [10000], parsePublicKey(organization.mainTokenMint));
                    return [4 /*yield*/, getTokenAccount(buddyTreasuryPDA, organization.mainTokenMint)];
                case 1:
                    buddyTreasuryATA = _b.sent();
                    if (!referrerTreasuryPDA) return [3 /*break*/, 3];
                    return [4 /*yield*/, getTokenAccount(referrerTreasuryPDA, organization.mainTokenMint)];
                case 2:
                    _a = _b.sent();
                    return [3 /*break*/, 4];
                case 3:
                    _a = null;
                    _b.label = 4;
                case 4:
                    referrerTreasuryATA = _a;
                    method = payer ? program.methods
                        .initMemberWithPayer(memberName) : program.methods
                        .initMember(memberName);
                    return [4 /*yield*/, method
                            .accounts(__assign({ associatedTokenProgram: ASSOCIATED_TOKEN_PROGRAM_ID, tokenProgram: TOKEN_PROGRAM_ID, systemProgram: anchor.web3.SystemProgram.programId, rent: anchor.web3.SYSVAR_RENT_PUBKEY, authority: authority, organization: organization.pda, buddyProfile: buddyProfile.pda, buddy: buddy.pda, ownerTreasury: buddyTreasuryPDA, ownerTreasuryTokenAccount: buddyTreasuryATA, member: memberPDA, mint: parsePublicKey(organization.mainTokenMint), globalReferrerTreasury: buddy.referrerTreasuryPda
                                ? parsePublicKey(buddy.referrerTreasuryPda)
                                : referrerTreasuryPDA, referrerTreasury: referrerTreasuryPDA, referrerTreasuryTokenAccount: referrerTreasuryATA }, (payer ? { payer: payer } : {})))
                            .remainingAccounts(__spreadArray([
                            //name check
                            {
                                pubkey: PublicKey.findProgramAddressSync([Buffer.from("paid_"), Buffer.from(memberName)], program.programId)[0],
                                isWritable: false,
                                isSigner: false
                            }
                        ], (organization.enforceWalletUniqueness
                            ? [
                                {
                                    pubkey: memberNamePDA,
                                    isWritable: true,
                                    isSigner: false
                                },
                            ]
                            : []), true))
                            .instruction()];
                case 5: return [2 /*return*/, _b.sent()];
            }
        });
    });
}
//# sourceMappingURL=initMember.js.map